
# Motor类

`Motor` 类是基于 Dynamixel SDK 的电机控制封装类，支持多种控制模式（位置、力控、电流等），适用于 Dynamixel 系列舵机的控制。

```python
def __init__(self, id, portHandler, packetHandler, curr_max=1750) -> None
```

### 参数说明

| 参数名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| `id` | int | 电机ID | - |
| `portHandler` | PortHandler | Dynamixel 端口处理器 | - |
| `packetHandler` | PacketHandler | Dynamixel 数据包处理器 | - |
| `curr_max` | int | 最大电流限制 (mA) | 1750 |

## 常量定义

### 单位换算
- `unit_scale = 0.087891` # 位置单位换算系数 (度/单位)

### 寄存器地址
| 常量名 | 地址 | 功能描述 |
|--------|------|----------|
| `addr_torq_enable` | 64 | 扭矩使能 |
| `addr_led` | 65 | LED控制 |
| `addr_present_pos` | 132 | 当前位置 |
| `addr_present_current` | 126 | 当前电流 |
| `addr_goal_pos` | 116 | 目标位置 |
| `addr_curr_limit` | 38 | 电流限制 |
| `addr_pos_p` | 84 | 位置P增益 |
| `addr_pos_i` | 82 | 位置I增益 |
| `addr_pos_d` | 80 | 位置D增益 |
| `addr_vel_limit` | 44 | 速度限制 |
| `addr_home_off` | 20 | 零点偏移 |
| `addr_goal_curr` | 102 | 目标电流 |
| `addr_goal_pwm` | 100 | 目标PWM |
| `addr_profile_acc` | 108 | 梯形速度加速度 |
| `addr_profile_vel` | 112 | 梯形速度速度限制 |
| `addr_operating_mode` | 11 | 运行模式 |

### 运行模式常量
| 模式 | 值 | 描述 |
|------|----|------|
| `curr_operating_mode` | 0 | 电流模式 |
| `vel_operating_mode` | 1 | 速度模式 |
| `pos_operating_mode` | 3 | 位置模式 |
| `extpos_operating_mode` | 4 | 扩展位置模式 |
| `currpos_operating_mode` | 5 | **推荐** - 电流位置控制模式（力位混合模式） |
| `pwm_operating_mode` | 16 | PWM控制模式 |

## 方法说明

### 1. LED 控制

#### `led_on()`
- **功能**: 开启电机LED
- **返回值**: 无

#### `led_off()`
- **功能**: 关闭电机LED
- **返回值**: 无

### 2. 扭矩控制

#### `torq_on()`
- **功能**: 打开电机使能（扭矩使能）
- **返回值**: 无

#### `torq_off()`
- **功能**: 关闭电机使能
- **返回值**: 无

### 3. 位置相关

#### `get_pos()`
- **功能**: 获取当前位置
- **返回值**: float - 当前位置（单位：度）
- **说明**: 会自动处理32位溢出问题

#### `set_zero()`
- **功能**: 设置当前位置为零点
- **返回值**: 无

#### `set_pos(pos)`
- **功能**: 设置目标位置
- **参数**: 
  - `pos` (float): 目标角度（度）
- **返回值**: 无

### 4. 控制模式设置

#### `pos_model()`
- **功能**: 设置为扩展位置模式
- **返回值**: 无
- **流程**: 
  1. 关闭扭矩
  2. 切换到扩展位置模式
  3. 开启扭矩

#### `pos_force_mode(goal_current=600, goal_pwm=200)`
- **功能**: 设置为电流位置控制模式（力位混合模式）
- **参数**:
  - `goal_current` (int): 目标电流 (mA) - 默认600
  - `goal_pwm` (int): 目标PWM - 默认200
- **返回值**: 无
- **注意**:
  - 在此模式下，位置PID和PWM限制值会被重置
  - 会自动检查并限制电流不超过设置的电流限制
  - PWM最大值限制为885

#### `force_mode()`
- **功能**: 设置为纯电流控制模式
- **返回值**: 无

### 5. 配置方法

#### `set_profile(acc, vel)`
- **功能**: 设置梯形速度参数
- **参数**:
  - `acc` (int): 加速度
  - `vel` (int): 速度限制
- **返回值**: 无

#### `set_curr_limit(curr=800)`
- **功能**: 设置电机最大电流限制
- **参数**:
  - `curr` (int): 电流限制 (mA) - 默认800
- **返回值**: 无
- **注意**: 会检查并限制不超过 `curr_max`

#### `init_config(curr_limit=1200, goal_current=600, goal_pwm=200)`
- **功能**: 初始化电机配置
- **参数**:
  - `curr_limit` (int): 电流限制 - 默认1200
  - `goal_current` (int): 目标电流 - 默认600
  - `goal_pwm` (int): 目标PWM - 默认200
- **返回值**: 无
- **流程**:
  1. LED闪烁2次作为指示灯
  2. 设置电流限制
  3. 设置为力位混合模式

### 6. PID控制

#### `set_pos_pid(kp, ki, kd)`
- **功能**: 设置位置PID参数
- **参数**:
  - `kp` (int): P增益
  - `ki` (int): I增益
  - `kd` (int): D增益
- **返回值**: 无

### 7. 电流控制

#### `set_curr(cur)`
- **功能**: 设置目标电流
- **参数**:
  - `cur` (int): 目标电流 (mA)
- **返回值**: 无


# Hand 类文档

## 概述

`Hand`控制GX10灵巧手。

## 类初始化

```python
def __init__(self, port=None, serial_number=None) -> None
```

### 参数说明

| 参数名 | 类型 | 说明 | 必须性 |
|--------|------|------|--------|
| `port` | str | 串口设备路径（如 `/dev/ttyUSB0`） | 二选一 |
| `serial_number` | str | USB转串口设备的序列号 | 二选一 |

### 注意事项
- `port` 和 `serial_number` 至少需要提供一个
- 如果两者都提供，优先使用 `port` 参数
- 如果只提供 `serial_number`，系统会自动搜索匹配的串口设备

### 属性说明

| 属性名 | 类型 | 说明 |
|--------|------|------|
| `is_connected` | bool | 连接状态标志 |
| `port` | str | 实际使用的串口设备路径 |
| `name` | str | 机械手名称（从全局常量 `NAME` 获取） |
| `portHandler` | PortHandler | Dynamixel 端口处理器 |
| `packetHandler` | PacketHandler | Dynamixel 数据包处理器 |
| `motors` | list[Motor] | 电机对象列表 |

## 方法说明

### 1. 连接与断开

#### `connect(curr_limit=1000, goal_current=600, goal_pwm=200)`
- **功能**: 连接到机械手并初始化所有电机
- **参数**:
  - `curr_limit` (int): 电机最大电流限制 (mA, 最大不超过1750) - 默认1000
  - `goal_current` (int): 目标电流限制 (mA, 不能超过 curr_limit) - 默认600
  - `goal_pwm` (int): 目标PWM限制 (0-885) - 默认200
- **返回值**: 无
- **流程**:
  1. 打开串口并设置波特率
  2. 创建所有电机对象（数量由全局常量 `NUM_MOTORS` 决定）
  3. 初始化每个电机的配置（力位混合模式）
  4. 打印连接成功信息
- **说明**:
  - `goal_current` 限制最大输出力
  - `goal_pwm` 限制运动速度
  - 连接失败时程序会退出

#### `off()`
- **功能**: 失能所有电机（关闭扭矩）
- **返回值**: 无
- **说明**: 安全停止所有电机的动作

#### `on()`
- **功能**: 使能所有电机（开启扭矩）
- **返回值**: 无

### 2. 位置控制

#### `home()`
- **功能**: 让机械手回到原点位置
- **返回值**: 无
- **说明**: 
  - 将所有关节移动到90度位置
  - 等待1秒确保动作完成
  - 基于安装方式：电机舵盘初始安装位置对应90度

#### `getjs()`
- **功能**: 获取所有关节的当前角度
- **返回值**: list[float] - 关节角度列表（单位：度）
- **说明**:
  - 返回的是相对于初始安装位置的角度
  - 从每个电机的原始位置减去90度得到实际关节角度
  - 数组长度为电机数量，索引0对应第一个关节

#### `setjs(js)`
- **功能**: 设置所有关节的目标角度
- **参数**: 
  - `js` (list[float]): 目标关节角度列表（单位：度）
- **返回值**: 无
- **说明**:
  - 输入的角度会加上90度后发送给电机
  - 数组长度必须等于电机数量
  - 基于安装方式的偏移处理

#### `setj(i, j)`
- **功能**: 设置单个关节的目标角度
- **参数**:
  - `i` (int): 关节索引（1到10）
  - `j` (float): 目标角度（单位：度）
- **返回值**: 无
- **说明**:
  - 索引超出范围时会打印错误信息
  - 同样会加上90度偏移
  - 适用于精细控制单个关节

# Glove 类文档

`Glove` 类控制EX12外骨骼手套。
## 类初始化

```python
def __init__(self, port=None, serial_number=None) -> None
```

### 参数说明

| 参数名 | 类型 | 说明 | 必须性 |
|--------|------|------|--------|
| `port` | str | 串口设备路径（如 `/dev/ttyUSB0`） | 二选一 |
| `serial_number` | str | USB转串口设备的序列号 | 二选一 |

### 注意事项
- `port` 和 `serial_number` 至少需要提供一个
- 如果两者都提供，优先使用 `port` 参数
- 如果只提供 `serial_number`，系统会自动搜索匹配的串口设备

### 属性说明

| 属性名 | 类型 | 说明 |
|--------|------|------|
| `is_connected` | bool | 连接状态标志 |
| `port` | str | 实际使用的串口设备路径 |
| `name` | str | 手套名称（从全局常量 `NAME` 获取） |
| `kin` | KinEX12 | 运动学模型对象，使用pybullet进行计算 |
| `portHandler` | PortHandler | Dynamixel 端口处理器 |
| `packetHandler` | PacketHandler | Dynamixel 数据包处理器 |
| `motors` | list[Motor] | 电机对象列表（12个） |
| `init_offsets` | list[int] | 初始角度偏移量数组 |

## 方法说明

### 1. 连接与断开

#### `connect()`
- **功能**: 连接到数据手套并初始化系统
- **参数**: 无
- **返回值**: 无
- **流程**:
  1. 打开串口并设置波特率
  2. 创建12个电机对象（对应12个关节）
  3. 读取初始关节位置
  4. 计算初始偏移量
  5. 关闭所有电机扭矩（只读模式）
- **特殊处理**:
  - 初始上电时，角度可能超过360度
  - 偏移量规则：如果初始角度小于270度，偏移为0；否则偏移为360度
- **说明**: 当前版本仅支持角度读取，不启用电机控制

#### `off()`
- **功能**: 失能所有电机（关闭扭矩）
- **返回值**: 无
- **说明**: 确保手套处于被动读取模式

### 2. 数据读取

#### `getjs()`
- **功能**: 获取EX12所有关节的当前角度
- **返回值**: `np.ndarray` - 12个关节的角度数组（单位：度）
- **计算公式**: 
  ```
  实际角度 = 原始角度 - 90° - 初始偏移量
  ```
- **关节分配**:
  - 索引 0-3: 大拇指（4个关节）
  - 索引 4-7: 食指（4个关节）
  - 索引 8-11: 中指（4个关节）

### 3. 运动学计算

#### `fk()`
- **功能**: 计算三指指尖的XYZ坐标
- **返回值**: 元组 `(finger1_xyz, finger2_xyz, finger3_xyz)`
  - `finger1_xyz`: 大拇指指尖坐标
  - `finger2_xyz`: 食指指尖坐标  
  - `finger3_xyz`: 中指指尖坐标
- **单位**: 米（m）
- **流程**:
  1. 获取当前所有关节角度
  2. 分别计算三指的指尖坐标
  3. 返回三个numpy数组


## 运动学模型

### 手指关节分配
```
大拇指: 关节 0-3 → finger1
食指:   关节 4-7 → finger2  
中指:   关节 8-11 → finger3
```

### 偏移量处理逻辑
```python
# 初始偏移量计算规则
if 初始角度 < 270°:
    偏移量 = 0
else:
    偏移量 = 360°

# 实际角度计算
实际角度 = 原始角度 - 90° - 偏移量
```
